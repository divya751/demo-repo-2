AWSTemplateFormatVersion: 2010-09-09
Description: Creates the Hosted Zone for the account top-level domain

Parameters:
  Environment:
    Type: String
  HostName:
    Type: String
  SESVerificationValue:
    Type: String
  MX:
    Type: String
  AutoDiscover:
    Type: String
  DkimVerification1:
    Type: String
  DkimVerification2:
    Type: String
  DkimVerification3:
    Type: String

Resources:
  HostedZone:
    Type: 'AWS::Route53::HostedZone'
    Properties:
      HostedZoneConfig:
        Comment: !Sub 'Hosted zone for ${HostName}'
      Name: !Ref HostName
  RecordSetGroup:
    DependsOn: HostedZone
    Type: 'AWS::Route53::RecordSetGroup'
    Properties:
      HostedZoneName: !Sub '${HostName}.'
      RecordSets:
        - Name: !Sub '_amazonses.${HostName}.'
          Type: TXT
          TTL: '900'
          ResourceRecords:
            - !Sub '"${SESVerificationValue}"'
        - Name: !Sub '${HostName}.'
          Type: MX
          TTL: '300'
          ResourceRecords:
            - !Ref MX
        - Name: !Sub 'autodiscover.${HostName}.'
          Type: CNAME
          TTL: '300'
          ResourceRecords:
            - !Ref AutoDiscover
        - Name: !Sub '${DkimVerification1}._domainkey.${HostName}.'
          Type: CNAME
          TTL: '300'
          ResourceRecords:
            - !Sub '${DkimVerification1}.dkim.amazonses.com.'
        - Name: !Sub '${DkimVerification2}._domainkey.${HostName}.'
          Type: CNAME
          TTL: '300'
          ResourceRecords:
            - !Sub '${DkimVerification2}.dkim.amazonses.com.'
        - Name: !Sub '${DkimVerification3}._domainkey.${HostName}.'
          Type: CNAME
          TTL: '300'
          ResourceRecords:
            - !Sub '${DkimVerification3}.dkim.amazonses.com.'

Outputs:
  HostedZone:
    Description: 'HostedZone id'
    Value: !Ref HostedZone
    Export:
      Name: AccountHostedZone
  DomainName:
    Description: 'Account-wide top-level domain'
    Value: !Ref HostName
    Export:
      Name: AccountHostName
  Environment:
    Value: !Ref Environment
    Export:
      Name: AccountEnvironment
